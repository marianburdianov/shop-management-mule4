<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	
	<sub-flow name="implementationGetCustomers">
		<db:select doc:name="selectCustomers" doc:id="cc6252c7-6462-4d94-b97a-0ce9ebcb80ca" config-ref="Shop_Management_Database_Config">
			<db:sql ><![CDATA[SELECT * 
FROM customers]]></db:sql>
		</db:select>
		<ee:transform xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd" doc:name="setCustomerPayload">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload map (customer, index) ->{
	customerId:customer.customer_id,
	firstName:customer.first_name,
	lastName:customer.last_name,
	phoneNumber:customer.phone_number,
    address:customer.address
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
	</sub-flow>
	<sub-flow name="implementationGetCustomerById">
		<set-variable value="#[message.attributes.uriParams.customerId]" doc:name="customerId" doc:id="0fd5737a-3ea1-4980-9a84-2fb30efa2c21" variableName="customerId"/>
		<db:select doc:name="selectCustomerById" doc:id="8e7fc0bd-e508-42c8-9393-02751e357bb3" config-ref="Shop_Management_Database_Config">
            <db:sql><![CDATA[SELECT * 
FROM customers
WHERE customer_id =:customer_id]]></db:sql>
            <db:input-parameters><![CDATA[#[{'customer_id' : vars.customerId}]]]></db:input-parameters>
        </db:select>
        <choice doc:name="Choice" doc:id="d297bd5b-9e15-4f1c-b7aa-50b16fa9bc66" >
			<when expression="#[payload[0] != null]">
				<ee:transform xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd" doc:name="setCustomerPayload">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload map (customer, index) ->{
	customerId:customer.customer_id,
	firstName:customer.first_name,
	lastName:customer.last_name,
	phoneNumber:customer.phone_number,
    address:customer.address
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
			</when>
			<otherwise >
				<ee:transform doc:name="setError404" doc:id="4bc4745a-bf30-44fe-8b6a-ccc32b197c38" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
  "code": 404,
  "message": "Not found"
}]]></ee:set-payload>
					</ee:message>
					<ee:variables >
						<ee:set-variable variableName="httpStatus" ><![CDATA[404]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
			</otherwise>
		</choice>
	</sub-flow>
	
	<sub-flow name="implementationPostCustomer">
		<db:insert doc:name="insertCustomer" doc:id="69f05a0f-025c-4893-bca3-077ce6b1adfc" config-ref="Shop_Management_Database_Config">
			<db:sql ><![CDATA[INSERT INTO customers ( first_name, last_name, phone_number, address) 
VALUES ( :first_name, :last_name, :phone_number, :address);]]></db:sql>
			<db:input-parameters ><![CDATA[#[{
	first_name : payload.firstName,
	last_name : payload.lastName,
	phone_number : payload.phoneNumber,
	address : payload.address
}]]]></db:input-parameters>
		</db:insert>
		<db:select doc:name="selectCustomer" doc:id="396c0c93-d16c-44f0-a89a-d26f0dbda956" config-ref="Shop_Management_Database_Config">
			<db:sql ><![CDATA[SELECT * 
FROM customers
WHERE customer_id=(select last_insert_id())]]></db:sql>
		</db:select>
		<ee:transform xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd" doc:name="setCustomerPayload">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload map (customer, index) ->{
	customerId:customer.customer_id,
	firstName:customer.first_name,
	lastName:customer.last_name,
	phoneNumber:customer.phone_number,
    address:customer.address
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
	</sub-flow>
	<sub-flow name="implementationUpdateCustomer">
		<set-variable value="#[attributes.uriParams.customerId]" doc:name="customerId" doc:id="ca6c3085-d4e5-4384-b74d-9bc2735ac8ad" variableName="customerId"/>
		<db:update doc:name="updateCustomer" doc:id="0054ae63-4700-4543-b7d6-ad7be2385e0b" config-ref="Shop_Management_Database_Config">
			<db:sql ><![CDATA[UPDATE customers 
SET first_name = :first_name, last_name = :last_name, phone_number = :phone_number, address = :address 
WHERE customer_id = :customer_id
]]></db:sql>
			<db:input-parameters ><![CDATA[#[{
	customer_id : vars.customerId,
	first_name : payload.firstName,
	last_name : payload.lastName,
	phone_number : payload.phoneNumber,
	address : payload.address
}]]]></db:input-parameters>
		</db:update>
		<db:select doc:name="selectCustomer" doc:id="9d9d3ba8-c2c9-4ebc-8423-bcc12260f5a7" config-ref="Shop_Management_Database_Config">
			<db:sql ><![CDATA[SELECT * 
FROM customers
WHERE customer_id =:customer_id]]></db:sql>
			<db:input-parameters ><![CDATA[#[{'customer_id' : vars.customerId}]]]></db:input-parameters>
		</db:select>
        <choice doc:name="Choice" doc:id="7381e69d-977b-4284-9315-a0fed19ca453" >
			<when expression="#[payload[0] != null]">
				<ee:transform xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd" doc:name="setCustomerPayload">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload map (customer, index) ->{
	"Status":200,
	"message":"Updated",
	customerId:customer.customer_id,
	firstName:customer.first_name,
	lastName:customer.last_name,
	phoneNumber:customer.phone_number,
    address:customer.address
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
			</when>
			<otherwise >
				<ee:transform doc:name="setError404" doc:id="776efd62-2ed1-4267-94c1-86c3e47f352a" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
  "code": 404,
  "message": "Not found"
}]]></ee:set-payload>
					</ee:message>
					<ee:variables >
						<ee:set-variable variableName="httpStatus" ><![CDATA[%dw 2.0
output application/java
---
{
}]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
			</otherwise>
		</choice>
	</sub-flow>
	<sub-flow name="implementationDeleteCustomer">
		<set-variable value="#[message.attributes.uriParams.customerId]" doc:name="customerId" doc:id="d399fdca-d470-40cb-ab5a-2697d4caf5fd" variableName="customerId"/>
		<db:select doc:name="selectCustomerById" doc:id="6f4a134e-51f7-4ba7-b05b-003b78ed8951" config-ref="Shop_Management_Database_Config">
			<db:sql ><![CDATA[SELECT * 
FROM customers
WHERE customer_id =:customer_id]]></db:sql>
			<db:input-parameters ><![CDATA[#[{'customer_id' : vars.customerId}]]]></db:input-parameters>
		</db:select>
		<choice doc:name="Choice" doc:id="8c8ccdd4-e4a3-41a5-9eb5-f97899378b7c" >
			<when expression="#[payload[0] != null]">
				<db:delete doc:name="deleteCustomer" doc:id="b6f67cee-40d1-4128-bdc0-0a75b0ee44e2" config-ref="Shop_Management_Database_Config">
			<db:sql><![CDATA[DELETE FROM customers WHERE customer_id = :customer_id]]></db:sql>
			<db:input-parameters><![CDATA[#[{'customer_id' : vars.customerId}]]]></db:input-parameters>
		</db:delete>
				<ee:transform doc:id="54101db3-3d41-4d52-8cf1-986529de510a" doc:name="setStatus200">
            <ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	"code": 200,
	"message": "Deleted"
}]]></ee:set-payload>
			</ee:message>
			<ee:variables>
				<ee:set-variable variableName="httpStatus"><![CDATA[200]]></ee:set-variable>
            </ee:variables>
        </ee:transform>
			</when>
			<otherwise >
				<ee:transform doc:name="setError404" doc:id="a2ff38d2-2191-4256-bebb-8d65c513a843" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
  "code": 404,
  "message": "Not found"
}]]></ee:set-payload>
					</ee:message>
					<ee:variables >
						<ee:set-variable variableName="httpStatus" ><![CDATA[404]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
			</otherwise>
		</choice>
	</sub-flow>
	
	</mule>
