<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">

<sub-flow name="implementationGetEmployees">
	<set-variable value="#[attributes.method]" doc:name="httpMethod" doc:id="2def4789-3109-478b-94c6-10c3db5b09c5" variableName="methodName"/>
		<db:select doc:name="selectEmployees" doc:id="cf92446c-da39-4b1c-b84d-18bc5efaab59" config-ref="Shop_Management_Database_Config">
			<db:sql ><![CDATA[SELECT * 
FROM employees]]></db:sql>
		</db:select>
		<ee:transform xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd" doc:name="setEmployeesPayload">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload map (employee, index) ->{
    employee:employee.employee_id,
	firstName:employee.first_name,
	lastName:employee.last_name,
	gender:employee.gender,
    birthDate:employee.birth_date,
    hireDate:employee.hire_date,
    role:employee.role,
    salary:employee.salary
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
</sub-flow>
<sub-flow name="implementationGetEmployeeById">
	<set-variable value="#[attributes.method]" doc:name="httpMethod" doc:id="e0412b8a-016d-47f6-8266-b922d6950eda" variableName="methodName"/>
		<set-variable value="#[message.attributes.uriParams.employeeId]" doc:name="employeeId" doc:id="75b65373-90de-4016-b888-9743c982119a" variableName="employeeId"/>
		<db:select doc:name="selectEmployeeById" doc:id="fa6c7208-d34f-4ab0-95bf-9c5813eb96d6" config-ref="Shop_Management_Database_Config">
            <db:sql><![CDATA[SELECT * 
FROM employees
WHERE employee_id =:employee_id]]></db:sql>
            <db:input-parameters><![CDATA[#[{'employee_id' : attributes.uriParams.employeeId}]]]></db:input-parameters>
        </db:select>
		<choice doc:name="Choice" doc:id="930f06f9-16b2-4b2e-838a-cf9fe62b04b7" >
			<when expression="#[payload[0] != null]">
				<ee:transform xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd" doc:name="setEmployeePayload">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload map (employee, index) ->{
    employee:employee.employee_id,
	firstName:employee.first_name,
	lastName:employee.last_name,
	gender:employee.gender,
    birthDate:employee.birth_date,
    hireDate:employee.hire_date,
    role:employee.role,
    salary:employee.salary
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
			</when>
			<otherwise >
				<ee:transform doc:name="setError404" doc:id="3f3d89d9-4e5a-48e8-ab2b-05699ef7ff34" >
					<ee:message >
						<ee:set-payload ><![CDATA[output application/json
---
{
  "code": 404,
  "message": "Not found"
}]]></ee:set-payload>
					</ee:message>
					<ee:variables >
						<ee:set-variable variableName="httpStatus" ><![CDATA[404]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
			</otherwise>
		</choice>
</sub-flow>
<sub-flow name="implementationPostEmployee">
	<set-variable value="#[attributes.method]" doc:name="httpMethod" doc:id="ba981ba9-c3ae-4193-8185-76c2fb6e38af" variableName="methodName"/>
		<db:insert doc:name="insertEmployee" doc:id="05c0a01a-2664-4635-8746-a9246653abb6" config-ref="Shop_Management_Database_Config">
			<db:sql ><![CDATA[INSERT INTO employees (first_name, last_name, gender, birth_date, hire_date, role, salary) 
VALUES (:first_name, :last_name, :gender, :birth_date, :hire_date, :role, :salary);]]></db:sql>
			<db:input-parameters ><![CDATA[#[{
	first_name : payload.firstName,
	last_name : payload.lastName,
	gender : payload.gender,
	birth_date : payload.birthDate,
	hire_date : payload.hireDate,
	role : payload.role,
	salary : payload.salary
}]]]></db:input-parameters>
		</db:insert>
		<db:select doc:name="selectEmployee" doc:id="6447e54a-c0d0-459b-bf21-89f13ba9a974" config-ref="Shop_Management_Database_Config">
			<db:sql ><![CDATA[SELECT * 
FROM employees
WHERE employee_id=(select last_insert_id())]]></db:sql>
		</db:select>
		<ee:transform xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd" doc:name="setEmployeePayload">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload map (employee, index) ->{
    employee:employee.employee_id,
	firstName:employee.first_name,
	lastName:employee.last_name,
	gender:employee.gender,
    birthDate:employee.birth_date,
    hireDate:employee.hire_date,
    role:employee.role,
    salary:employee.salary
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
</sub-flow>	
<sub-flow name="implementationUpdateEmployee">
	<set-variable value="#[attributes.method]" doc:name="httpMethod" doc:id="9665a3d5-1fbf-4956-a43e-e837e9fff3b6" variableName="methodName"/>
		<set-variable value="#[attributes.uriParams.employeeId]" doc:name="employeeId" doc:id="f118ee73-786b-4146-839c-766e513f6b31" variableName="employeeId"/>
		<db:update doc:name="updaateEmployee" doc:id="464e95b7-883c-4757-8a41-6702bc8ec08b" config-ref="Shop_Management_Database_Config">
			<db:sql ><![CDATA[UPDATE employees 
SET first_name = :first_name, last_name = :last_name, gender = :gender, birth_date = :birth_date, hire_date = :hire_date, role = :role, salary = :salary 
WHERE employee_id = :employee_id
]]></db:sql>
			<db:input-parameters ><![CDATA[#[{
	employee_id : vars.employeeId,
	first_name : payload.firstName,
	last_name : payload.lastName,
	gender : payload.gender,
	birth_date : payload.birthDate,
	hire_date : payload.hireDate,
	role : payload.role,
	salary : payload.salary
}]]]></db:input-parameters>
		</db:update>
        <db:select doc:name="selectEmploee" doc:id="453af9d2-a0fb-4b83-9f4f-255a9be9145e" config-ref="Shop_Management_Database_Config">
			<db:sql ><![CDATA[SELECT * 
FROM employees
WHERE employee_id =:employee_id]]></db:sql>
			<db:input-parameters ><![CDATA[#[{employee_id : vars.employeeId}]]]></db:input-parameters>
		</db:select>
		<choice doc:name="Choice" doc:id="deedb549-9d60-48a4-8691-7df37998c5a5" >
			<when expression="#[payload[0] != null]">
				<ee:transform xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd" doc:name="setEmployeePayload">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload map (employee, index) ->{
	"Status":200,
	"message":"Updated",
    employee:employee.employee_id,
	firstName:employee.first_name,
	lastName:employee.last_name,
	gender:employee.gender,
    birthDate:employee.birth_date,
    hireDate:employee.hire_date,
    role:employee.role,
    salary:employee.salary
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
			</when>
			<otherwise >
				<ee:transform doc:name="setError404" doc:id="15534afe-aeed-4410-ac96-0416bb567fa5" >
					<ee:message >
						<ee:set-payload ><![CDATA[output application/json
---
{
  "code": 404,
  "message": "Not found"
}]]></ee:set-payload>
					</ee:message>
					<ee:variables >
						<ee:set-variable variableName="httpStatus" ><![CDATA[404]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
			</otherwise>
		</choice>
</sub-flow>
<sub-flow name="implementationDeleteEmployee">
	<set-variable value="#[attributes.method]" doc:name="httpMethod" doc:id="d221592a-03af-498b-8fa3-0f0b4ffd8cac" variableName="methodName"/>
		<set-variable value="#[message.attributes.uriParams.employeeId]" doc:name="employeeId" doc:id="36f29a23-3946-455d-aa34-45b60728bcfc" variableName="employeeId"/>
		<db:delete doc:name="deleteEmployee" doc:id="70616bce-1ee3-4948-9836-fb490d4ad77a" config-ref="Shop_Management_Database_Config">
			<db:sql ><![CDATA[DELETE FROM employees WHERE employee_id = :employee_id]]></db:sql>
			<db:input-parameters ><![CDATA[#[{'employee_id' : vars.employeeId}]]]></db:input-parameters>
		</db:delete>
		<ee:transform doc:name="setEmployeePayload">
            <ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	"Status": 204,
	"message": "Deleted"
}]]></ee:set-payload>
			</ee:message>
			<ee:variables>
                <ee:set-variable variableName="employeeId"><![CDATA[attributes.uriParams.'employeeId']]></ee:set-variable>
            </ee:variables>
        </ee:transform>
</sub-flow>
	
</mule>
